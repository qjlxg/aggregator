name: Filter Clash Nodes

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  filter_nodes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: 安装依赖
        run: pip install -r ./requirements.txt

      - name: 安装 pysocks
        run: pip install pysocks
        
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml dnspython

      - name: 创建数据目录
        run: |
          mkdir -p data
          chmod 777 data

      - name: Make Clash binary executable
        run: |
          chmod +x clash/clash-linux

      - name: Run node filtering script
        run: |
          python filter_nodes.py

      - name: 调试文件位置和权限
        run: |
          echo "当前工作目录："
          pwd
          echo "当前目录文件列表："
          ls -la
          echo "data 目录内容："
          ls -la data/ || echo "data 目录不存在"
          echo "查找 google.yaml 文件："
          find . -name "google.yaml" -ls || echo "未找到 google.yaml 文件"
          echo "文件系统权限："
          df -h .

      - name: 显示文件内容（如果存在）
        run: |
          if [ -f "data/google.yaml" ]; then
            echo "文件存在于 data/google.yaml"
            echo "文件内容："
            cat data/google.yaml
            echo "文件大小：$(stat -c%s data/google.yaml) 字节"
            echo "文件权限："
            ls -l data/google.yaml
          else
            echo "在 data/google.yaml 未找到文件"
            echo "尝试在其他位置查找："
            find . -name "google.yaml"
            exit 1
          fi
