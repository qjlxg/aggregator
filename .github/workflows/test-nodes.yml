name: Test Proxy Nodes with Clash
on: [push, workflow_dispatch]
jobs:
  test-nodes:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 安装 Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 安装 Clash
        run: |
          # 安装 jq 以解析 JSON
          sudo apt-get update
          sudo apt-get install -y jq
          
          # 获取 MetaCubeX/Clash.Meta 的最新发布信息
          RELEASE_INFO=$(curl -s https://api.github.com/repos/MetaCubeX/Clash.Meta/releases/latest)
          
          # 提取 Linux AMD64 二进制文件的下载链接
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains("linux-amd64")) | .browser_download_url')
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "错误：未找到 Linux AMD64 二进制文件。"
            exit 1
          fi
          
          # 下载二进制文件
          wget "$DOWNLOAD_URL" -O clash.gz
          
          # 解压 .gz 文件
          gunzip clash.gz
          
          # 移动并设置权限
          sudo mv clash /usr/local/bin/clash
          sudo chmod +x /usr/local/bin/clash
          
          # 验证安装
          clash -v

      - name: 生成 Clash 配置文件
        run: python generate_config.py

      - name: 运行测试脚本
        run: python test_nodes.py

      - name: 提交结果
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add data/sp.txt
          git commit -m "更新有效节点" || echo "无更改"
          git push
